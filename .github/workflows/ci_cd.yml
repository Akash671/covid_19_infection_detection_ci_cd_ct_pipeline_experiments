name: Model Training and Artifact Update Pipeline

# 1. CRITICAL FIX: Define when the workflow should run
on:
  # Run automatically when code is pushed to the main branch
  push:
    branches:
      - main
  # Allow manual triggering from the GitHub Actions UI
  workflow_dispatch:

jobs:
  train_and_update_model:
    runs-on: ubuntu-latest
    
    # 2. CRITICAL FIX: Grant write permission to the GITHUB_TOKEN for this job
    permissions:
      contents: write 
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 3. CRITICAL FIX: Use the GITHUB_TOKEN for subsequent push operations
          token: ${{ secrets.GITHUB_TOKEN }}
          # Fetch full history is necessary for git commands like push/commit
          fetch-depth: 0 

      - name: Setup Python environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        # Assuming your dependencies are consolidated into a single requirements.txt 
        # for the training pipeline (or you can install api/training requirements)
        run: |
          pip install --upgrade pip
          pip install -r training/requirements.txt # Adjust this path as needed

      - name: Run training and commit changes
        run: |
          # Configure Git user for the commit
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          # 4. CRITICAL FIX: Run the training script as a module
          python -m training.train
          
          # Add the new model artifact
          git add model_artifacts/model_20251118_152002.pkl
          
          # Check if there are any changes to commit before proceeding
          if git status --porcelain | grep -q 'model_artifacts/'; then
            git commit -m "CI/CD: Updated model via training pipeline [skip ci]"
            
            # Push the changes (This uses the token set in the checkout step)
            git push
            echo "Successfully committed and pushed new model artifact."
          else
            echo "No changes in model artifacts. Skipping commit."
          fi