name: Model Training and Artifact Update Pipeline

# 1. FIX: Define when the workflow should run (Trigger on push and manually)
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  train_and_update_model:
    runs-on: ubuntu-latest
    
    # 2. FIX: Grant write permission to the GITHUB_TOKEN for this job 
    permissions:
      contents: write 
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 3. FIX: Use the GITHUB_TOKEN for authenticated push
          token: ${{ secrets.GITHUB_TOKEN }}
          # Fetch full history is necessary for git commands like push/commit
          fetch-depth: 0 

      - name: Setup Python environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        # Assuming your dependencies are in training/requirements.txt
        run: |
          pip install --upgrade pip
          pip install -r training/requirements.txt 

      - name: Run training and commit changes
        run: |
          # Configure Git user for the commit
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          # Run the training script as a module
          python -m training.train
          
          # 4. CRITICAL FIX: Add the stable artifact paths, NOT the time-stamped path.
          # The training script updates these two files every run:
          git add model_artifacts/latest_model.pkl
          git add api/model.pkl
          
          # Check if there are any changes to commit before proceeding
          if git status --porcelain | grep -q 'model_artifacts/' || git status --porcelain | grep -q 'api/'; then
            git commit -m "CI/CD: Updated model via training pipeline [skip ci]"
            
            # Push the changes (This uses the token set in the checkout step)
            git push
            echo "Successfully committed and pushed new model artifacts."
          else
            echo "No changes in tracked artifacts. Skipping commit."
          fi